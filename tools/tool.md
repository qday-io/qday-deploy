# QDay éƒ¨ç½²å·¥å…·ä½¿ç”¨è¯´æ˜

æœ¬ç›®å½•åŒ…å«äº† QDay é¡¹ç›®éƒ¨ç½²å’Œæµ‹è¯•è¿‡ç¨‹ä¸­ä½¿ç”¨çš„å„ç§å·¥å…·ã€‚

## ç›®å½•ç»“æ„

```
tools/
â”œâ”€â”€ batch/                    # æ‰¹å¤„ç†å·¥å…·
â”‚   â”œâ”€â”€ batch-util-mac       # macOS æ‰¹å¤„ç†å·¥å…·
â”‚   â”œâ”€â”€ batch-utils-linux    # Linux æ‰¹å¤„ç†å·¥å…·
â”‚   â””â”€â”€ config.yaml          # æ‰¹å¤„ç†å·¥å…·é…ç½®æ–‡ä»¶
â”œâ”€â”€ gen-keystore.sh          # å¯†é’¥åº“ç”Ÿæˆè„šæœ¬
â”œâ”€â”€ keystore.js              # å¯†é’¥åº“ç”Ÿæˆæ ¸å¿ƒé€»è¾‘
â”œâ”€â”€ keystore-decrypt.js      # å¯†é’¥åº“è§£å¯†å·¥å…·
â”œâ”€â”€ send-tx.js               # å•æ¬¡äº¤æ˜“å‘é€å·¥å…·
â”œâ”€â”€ send-tx-loop.js          # å¾ªç¯äº¤æ˜“å‘é€å·¥å…·
â””â”€â”€ tool.md                  # æœ¬è¯´æ˜æ–‡æ¡£
```

## å·¥å…·è¯¦ç»†è¯´æ˜

### 1. å¯†é’¥åº“ç”Ÿæˆå·¥å…·

#### gen-keystore.sh
**åŠŸèƒ½**: è‡ªåŠ¨åŒ–å¯†é’¥åº“ç”Ÿæˆè„šæœ¬ï¼Œç”¨äºåˆå§‹åŒ–é¡¹ç›®ç¯å¢ƒå’Œç”Ÿæˆå¯†é’¥åº“æ–‡ä»¶ã€‚

**ä½¿ç”¨æ–¹æ³•**:
```bash
cd tools
./gen-keystore.sh
```

**å‰ç½®æ¡ä»¶**:
- é¡¹ç›®æ ¹ç›®å½•éœ€è¦å­˜åœ¨ `.env` æ–‡ä»¶
- `.env` æ–‡ä»¶ä¸­éœ€è¦è®¾ç½® `MNEMONIC` ç¯å¢ƒå˜é‡

**åŠŸèƒ½è¯´æ˜**:
- è‡ªåŠ¨æ£€æŸ¥å¹¶åˆå§‹åŒ– npm é¡¹ç›®
- å®‰è£…å¿…è¦çš„ä¾èµ–åŒ… (ethers, dotenv)
- éªŒè¯ `.env` æ–‡ä»¶å­˜åœ¨æ€§
- è°ƒç”¨ `keystore.js` ç”Ÿæˆå¯†é’¥åº“æ–‡ä»¶

#### keystore.js
**åŠŸèƒ½**: æ ¸å¿ƒå¯†é’¥åº“ç”Ÿæˆé€»è¾‘ï¼Œæ ¹æ®åŠ©è®°è¯ä¸ºä¸åŒè§’è‰²ç”Ÿæˆé’±åŒ…å’Œå¯†é’¥åº“æ–‡ä»¶ã€‚

**ç”Ÿæˆçš„è§’è‰²åˆ—è¡¨**:
1. L1 Deployment Address
2. L1 Trusted sequencer
3. L1 Trusted aggregator
4. L1 Trusted committer
5. L2 Trusted indexer
6. L2 Trusted validator
7. L2 Trusted fund
8. L2 Trusted market
9. L2 Trusted team
10. L2 Trusted investor

**è¾“å‡ºå†…å®¹**:
- æ¯ä¸ªè§’è‰²çš„åœ°å€ (Address)
- ç§é’¥ (Private Key)
- åŠ©è®°è¯ (Mnemonic)
- åŠ å¯†çš„å¯†é’¥åº“æ–‡ä»¶ (ä¿å­˜åˆ° `temp_keystore/` ç›®å½•)

**å¯†é’¥åº“å¯†ç **: é»˜è®¤ä½¿ç”¨ `testonly` ä½œä¸ºåŠ å¯†å¯†ç 

#### keystore-decrypt.js
**åŠŸèƒ½**: è§£å¯†å¯†é’¥åº“æ–‡ä»¶ï¼Œæå–é’±åŒ…ä¿¡æ¯ã€‚

**ä½¿ç”¨æ–¹æ³•**:
```bash
node keystore-decrypt.js <keystore-file> <password>
```

**å‚æ•°è¯´æ˜**:
- `<keystore-file>`: å¯†é’¥åº“æ–‡ä»¶è·¯å¾„
- `<password>`: å¯†é’¥åº“å¯†ç  (é»˜è®¤: testonly)

**è¾“å‡ºå†…å®¹**:
- é’±åŒ…åœ°å€ (Address)
- ç§é’¥ (Private Key)
- å…¬é’¥ (Public Key)

**ç¤ºä¾‹**:
```bash
node keystore-decrypt.js temp_keystore/0.keystore testonly
```

### 2. äº¤æ˜“å‘é€å·¥å…·

#### send-tx.js
**åŠŸèƒ½**: å‘é€å•æ¬¡ä»¥å¤ªåŠäº¤æ˜“ã€‚

**é…ç½®è¯´æ˜**:
åœ¨æ–‡ä»¶é¡¶éƒ¨ä¿®æ”¹ä»¥ä¸‹é…ç½®å‚æ•°ï¼š
```javascript
const privateKey = '0x...';           // å‘é€æ–¹ç§é’¥ (éœ€è¦0xå‰ç¼€)
const to = '0x...';                   // æ¥æ”¶æ–¹åœ°å€
const valueEth = '0.01';              // å‘é€é‡‘é¢ (ETH)
const rpcUrl = 'http://...:8123';     // RPC èŠ‚ç‚¹åœ°å€
```

**ä½¿ç”¨æ–¹æ³•**:
```bash
node send-tx.js
```

**åŠŸèƒ½ç‰¹æ€§**:
- è‡ªåŠ¨æ£€æŸ¥ç§é’¥æ ¼å¼
- æ˜¾ç¤ºé’±åŒ…ä½™é¢
- å‘é€äº¤æ˜“å¹¶ç­‰å¾…ç¡®è®¤
- é”™è¯¯å¤„ç†å’ŒçŠ¶æ€æç¤º

#### send-tx-loop.js
**åŠŸèƒ½**: å¾ªç¯å‘é€å¤šç¬”äº¤æ˜“ï¼Œæ”¯æŒå‹åŠ›æµ‹è¯•å’Œè‡ªåŠ¨åŒ–äº¤æ˜“ã€‚

**é…ç½®è¯´æ˜**:
åœ¨æ–‡ä»¶é¡¶éƒ¨ä¿®æ”¹ä»¥ä¸‹é…ç½®å‚æ•°ï¼š
```javascript
const privateKey = '0x...';           // å‘é€æ–¹ç§é’¥
const to = '0x...';                   // æ¥æ”¶æ–¹åœ°å€
const valueEth = '0.01';              // æ¯æ¬¡å‘é€é‡‘é¢ (ETH)
const rpcUrl = 'http://...:8123';     // RPC èŠ‚ç‚¹åœ°å€

// å¾ªç¯é…ç½®
const intervalSeconds = 30;           // å‘é€é—´éš” (ç§’)
const maxTransactions = 10;           // æœ€å¤§å‘é€æ¬¡æ•° (0=æ— é™å¾ªç¯)
const enableRandomAmount = true;      // æ˜¯å¦å¯ç”¨éšæœºé‡‘é¢
const minAmount = 0.001;              // æœ€å°é‡‘é¢ (ETH)
const maxAmount = 0.02;               // æœ€å¤§é‡‘é¢ (ETH)
```

**ä½¿ç”¨æ–¹æ³•**:
```bash
node send-tx-loop.js
```

**åŠŸèƒ½ç‰¹æ€§**:
- æ”¯æŒå›ºå®šé—´éš”å¾ªç¯å‘é€
- å¯é…ç½®æœ€å¤§å‘é€æ¬¡æ•°
- æ”¯æŒéšæœºé‡‘é¢å‘é€
- å®æ—¶ä½™é¢æ£€æŸ¥
- ä¼˜é›…é€€å‡ºå¤„ç† (Ctrl+C)
- è¯¦ç»†çš„æ—¥å¿—è¾“å‡ºå’Œæ—¶é—´æˆ³
- é”™è¯¯é‡è¯•æœºåˆ¶

**æ§åˆ¶å‘½ä»¤**:
- `Ctrl+C`: ä¼˜é›…åœæ­¢å¾ªç¯
- è‡ªåŠ¨æ£€æŸ¥ä½™é¢ä¸è¶³æƒ…å†µ

### 3. æ‰¹å¤„ç†å·¥å…·

#### batch-util-mac / batch-utils-linux
**åŠŸèƒ½**: è·¨å¹³å°æ‰¹å¤„ç†å·¥å…·ï¼Œç”¨äºæ•°æ®åº“æ“ä½œå’Œç³»ç»Ÿç®¡ç†ï¼Œæ”¯æŒé€šè¿‡ hash å€¼è¿›è¡Œç‰¹å®šæ“ä½œã€‚

**ä½¿ç”¨æ–¹æ³•**:
```bash
# macOS
./batch/batch-util-mac -hash=0x...

# Linux
./batch/batch-utils-linux -hash=0x...
```

**å‚æ•°è¯´æ˜**:
- `-hash string`: è¾“å…¥è¦å¤„ç†çš„ hash å€¼ï¼ˆå¿…éœ€å‚æ•°ï¼‰

**ç¤ºä¾‹**:
```bash
# å¤„ç†ç‰¹å®šçš„äº¤æ˜“ hash
./batch/batch-util-mac -hash=0x1234567890abcdef1234567890abcdef1234567890abcdef1234567890abcdef

# å¤„ç†åŒºå— hash
./batch/batch-util-mac -hash=0xabcdef1234567890abcdef1234567890abcdef1234567890abcdef1234567890
```

**åŠŸèƒ½ç‰¹æ€§**:
- æ”¯æŒäº¤æ˜“ hash å’ŒåŒºå— hash å¤„ç†
- æ ¹æ® hash å€¼åœ¨æ•°æ®åº“ä¸­æŸ¥æ‰¾ç›¸å…³ä¿¡æ¯
- å¯èƒ½æ¶‰åŠçŠ¶æ€æ•°æ®åº“å’Œæäº¤è€…æ•°æ®åº“çš„æŸ¥è¯¢æ“ä½œ

#### config.yaml
**åŠŸèƒ½**: æ‰¹å¤„ç†å·¥å…·çš„é…ç½®æ–‡ä»¶ã€‚

**é…ç½®å†…å®¹**:
```yaml
statedb:
  host: "190.92.213.101"
  port: 5432
  user: "state_user"
  password: "state_password"
  dbname: "state_db"
  sslmode: "disable"

committerdb:
  host: "190.92.213.101"
  port: 3366
  user: "root"
  password: "root"
  dbname: "abe_committer"
```

**æ•°æ®åº“é…ç½®è¯´æ˜**:
- `statedb`: çŠ¶æ€æ•°æ®åº“é…ç½® (PostgreSQL)
- `committerdb`: æäº¤è€…æ•°æ®åº“é…ç½® (MySQL)

## ä½¿ç”¨æµç¨‹ç¤ºä¾‹

### 1. åˆå§‹åŒ–å¯†é’¥åº“
```bash
# 1. åœ¨é¡¹ç›®æ ¹ç›®å½•åˆ›å»º .env æ–‡ä»¶
echo "MNEMONIC=your twelve word mnemonic phrase here" > .env

# 2. ç”Ÿæˆå¯†é’¥åº“
cd tools
./gen-keystore.sh
```

### 2. è§£å¯†å¯†é’¥åº“æ–‡ä»¶
```bash
# è§£å¯†ç‰¹å®šè§’è‰²çš„å¯†é’¥åº“
node keystore-decrypt.js temp_keystore/0.keystore testonly
```

### 3. å‘é€æµ‹è¯•äº¤æ˜“
```bash
# å‘é€å•ç¬”äº¤æ˜“
node send-tx.js

# å¾ªç¯å‘é€äº¤æ˜“ (å‹åŠ›æµ‹è¯•)
node send-tx-loop.js
```

### 4. ä½¿ç”¨æ‰¹å¤„ç†å·¥å…·
```bash
# æ ¹æ®æ“ä½œç³»ç»Ÿé€‰æ‹©å¯¹åº”å·¥å…·ï¼Œå¤„ç†ç‰¹å®š hash
./batch/batch-util-mac -hash=0x1234567890abcdef1234567890abcdef1234567890abcdef1234567890abcdef    # macOS
./batch/batch-utils-linux -hash=0x1234567890abcdef1234567890abcdef1234567890abcdef1234567890abcdef # Linux
```

## æ³¨æ„äº‹é¡¹

1. **å®‰å…¨æ€§**: 
   - ç§é’¥å’ŒåŠ©è®°è¯è¯·å¦¥å–„ä¿ç®¡
   - ç”Ÿäº§ç¯å¢ƒè¯·ä½¿ç”¨å¼ºå¯†ç 
   - ä¸è¦å°†æ•æ„Ÿä¿¡æ¯æäº¤åˆ°ç‰ˆæœ¬æ§åˆ¶

2. **ç½‘ç»œé…ç½®**:
   - ç¡®ä¿ RPC èŠ‚ç‚¹åœ°å€æ­£ç¡®
   - æ£€æŸ¥ç½‘ç»œè¿æ¥å’Œé˜²ç«å¢™è®¾ç½®

3. **ä½™é¢æ£€æŸ¥**:
   - å‘é€äº¤æ˜“å‰ç¡®ä¿é’±åŒ…æœ‰è¶³å¤Ÿä½™é¢
   - è€ƒè™‘ gas è´¹ç”¨

4. **é”™è¯¯å¤„ç†**:
   - å·¥å…·åŒ…å«é”™è¯¯å¤„ç†æœºåˆ¶
   - æŸ¥çœ‹æ§åˆ¶å°è¾“å‡ºäº†è§£è¯¦ç»†é”™è¯¯ä¿¡æ¯

5. **æƒé™è®¾ç½®**:
   - ç¡®ä¿è„šæœ¬æ–‡ä»¶æœ‰æ‰§è¡Œæƒé™
   - Linux/macOS: `chmod +x gen-keystore.sh`

## æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **MNEMONIC æœªè®¾ç½®**
   ```
   [ERROR] MNEMONIC environment variable not found
   ```
   **è§£å†³æ–¹æ¡ˆ**: åœ¨é¡¹ç›®æ ¹ç›®å½•åˆ›å»º `.env` æ–‡ä»¶å¹¶è®¾ç½® MNEMONIC

2. **ç§é’¥æ ¼å¼é”™è¯¯**
   ```
   Private key must start with 0x
   ```
   **è§£å†³æ–¹æ¡ˆ**: ç¡®ä¿ç§é’¥ä»¥ `0x` å¼€å¤´

3. **ä½™é¢ä¸è¶³**
   ```
   Insufficient funds in wallet
   ```
   **è§£å†³æ–¹æ¡ˆ**: å‘é’±åŒ…åœ°å€è½¬å…¥è¶³å¤Ÿçš„ ETH

4. **ç½‘ç»œè¿æ¥å¤±è´¥**
   ```
   Network error - check RPC URL
   ```
   **è§£å†³æ–¹æ¡ˆ**: æ£€æŸ¥ RPC URL å’Œç½‘ç»œè¿æ¥

5. **å¯†é’¥åº“è§£å¯†å¤±è´¥**
   ```
   Failed to decrypt keystore
   ```
   **è§£å†³æ–¹æ¡ˆ**: æ£€æŸ¥å¯†ç æ˜¯å¦æ­£ç¡® (é»˜è®¤: testonly)

6. **æ‰¹å¤„ç†å·¥å…·å‚æ•°é”™è¯¯**
   ```
   Usage of ./batch-util-mac:
     -hash string
           è¾“å…¥è¦å¤„ç†çš„ hash å€¼
   ```
   **è§£å†³æ–¹æ¡ˆ**: ç¡®ä¿æä¾›äº† `-hash` å‚æ•°ï¼Œæ ¼å¼ä¸º `-hash=0x...`

### æ—¥å¿—çº§åˆ«

å·¥å…·ä½¿ç”¨ä¸åŒçš„æ—¥å¿—çº§åˆ«ï¼š
- `[INFO]`: ä¿¡æ¯æç¤º
- `[ERROR]`: é”™è¯¯ä¿¡æ¯
- `âœ…`: æˆåŠŸæ“ä½œ
- `âŒ`: å¤±è´¥æ“ä½œ
- `â³`: ç­‰å¾…çŠ¶æ€
- `ğŸš€`: å¼€å§‹æ“ä½œ
- `ğŸ¯`: ç›®æ ‡çŠ¶æ€

## ç‰ˆæœ¬ä¿¡æ¯

- **ethers**: v5
- **Node.js**: å»ºè®® v14+
- **æ“ä½œç³»ç»Ÿ**: Linux, macOS, Windows (WSL)

## æ›´æ–°æ—¥å¿—

- åˆå§‹ç‰ˆæœ¬: åŸºç¡€å¯†é’¥åº“ç”Ÿæˆå’Œäº¤æ˜“å‘é€åŠŸèƒ½
- æ”¯æŒå¾ªç¯äº¤æ˜“å‘é€å’Œå‹åŠ›æµ‹è¯•
- æ·»åŠ æ‰¹å¤„ç†å·¥å…·å’Œé…ç½®æ–‡ä»¶
- å®Œå–„é”™è¯¯å¤„ç†å’Œæ—¥å¿—è¾“å‡º
