# PostgreSQL Replication on Docker Compose

## Step 1: Master Database

> Host: qday-sg-04(119.13.103.230)

Create the directory for the database and scripts.

```bash
$ mkdir -p ~/deploy/postgres/data
$ sudo chown -R 70:70 ~/deploy/postgres/data
$ cd ~/deploy/postgres
```

Create the docker compose file for the master database.

```bash
$ vim docker-compose.yml
services:
  
  postgres:
    image: postgres:17-alpine
    container_name: postgres
    user: postgres
    restart: always
    ports:
      - "5432:5432"
    environment:
      POSTGRES_PASSWORD: cA1FLIhCPuCaHngv
      POSTGRES_HOST_AUTH_METHOD: "scram-sha-256\nhost replication all 0.0.0.0/0 md5"
      POSTGRES_INITDB_ARGS: "--auth-host=scram-sha-256"
    volumes:
      - ./data:/var/lib/postgresql/data
    command: |
      postgres 
      -c wal_level=replica 
      -c hot_standby=on 
      -c max_wal_senders=10 
      -c max_replication_slots=10 
      -c hot_standby_feedback=on
      -c max_connections=1000
```

Start the master database.

```bash
$ docker compose up -d
```

Check the logs.

```bash
$ docker compose logs -f
```

Create a replication user and slot.

```bash
$ docker exec -it postgres psql -U postgres

CREATE USER replicator WITH REPLICATION ENCRYPTED PASSWORD 'DymnUDlHdiNVCq1O';
SELECT PG_CREATE_PHYSICAL_REPLICATION_SLOT('replication_slot');
```

## Step 2: Slave Database

> Host: abec-fn00-hz01(116.202.169.210)

Create the directory for the database.

```bash
$ mkdir -p ~/deploy/postgres/data
$ sudo chown -R 70:70 ~/deploy/postgres/data
$ cd ~/deploy/postgres
```

Create the docker compose file for the slave database.

```bash
$ vim docker-compose.yml
services:
  
  postgres:
    image: postgres:17-alpine
    container_name: postgres
    user: postgres
    restart: always
    ports:
      - "5432:5432"
    environment:
      PGUSER: replicator
      PGPASSWORD: DymnUDlHdiNVCq1O
    extra_hosts:
      - "pg-master:119.13.103.230"
    volumes:
      - ./data:/var/lib/postgresql/data
    command: |
      bash -c "
      if [ -f /var/lib/postgresql/data/PG_VERSION ]; then
          echo 'Data directory already exists, skip pg_basebackup...'
      else
          echo 'Data directory empty, do initial basebackup from master...'
          until pg_basebackup --pgdata=/var/lib/postgresql/data -R --slot=replication_slot --host=pg-master --port=5432
          do
            echo 'Waiting for primary to connect...'
            sleep 1s
          done
          echo 'Base backup done.'
          echo 'max_connections = 1000' >> /var/lib/postgresql/data/postgresql.conf
          chmod 0700 /var/lib/postgresql/data
      fi
      echo 'Starting PostgreSQL...'
      exec postgres
      "
```

Start the slave database.

```bash
$ docker compose up -d
```

Check the logs.

```bash
$ docker compose logs -f
postgres  | Data directory empty, do initial basebackup from master...
postgres  | Base backup done.
postgres  | Starting PostgreSQL...
postgres  | 2025-03-05 11:47:14.310 UTC [1] LOG:  starting PostgreSQL 17.4 on x86_64-pc-linux-musl, compiled by gcc (Alpine 14.2.0) 14.2.0, 64-bit
postgres  | 2025-03-05 11:47:14.310 UTC [1] LOG:  listening on IPv4 address "0.0.0.0", port 5432
postgres  | 2025-03-05 11:47:14.310 UTC [1] LOG:  listening on IPv6 address "::", port 5432
postgres  | 2025-03-05 11:47:14.321 UTC [1] LOG:  listening on Unix socket "/var/run/postgresql/.s.PGSQL.5432"
postgres  | 2025-03-05 11:47:14.334 UTC [12] LOG:  database system was interrupted; last known up at 2025-03-05 11:43:35 UTC
postgres  | 2025-03-05 11:47:14.693 UTC [12] LOG:  starting backup recovery with redo LSN 0/2000028, checkpoint LSN 0/20000B8, on timeline ID 1
postgres  | 2025-03-05 11:47:14.693 UTC [12] LOG:  entering standby mode
postgres  | 2025-03-05 11:47:14.704 UTC [12] LOG:  redo starts at 0/2000028
postgres  | 2025-03-05 11:47:14.710 UTC [12] LOG:  completed backup recovery with redo LSN 0/2000028 and end LSN 0/2024810
postgres  | 2025-03-05 11:47:14.711 UTC [12] LOG:  consistent recovery state reached at 0/2024810
postgres  | 2025-03-05 11:47:14.711 UTC [12] LOG:  invalid record length at 0/3000060: expected at least 24, got 0
postgres  | 2025-03-05 11:47:14.711 UTC [1] LOG:  database system is ready to accept read-only connections
postgres  | 2025-03-05 11:47:17.122 UTC [13] LOG:  started streaming WAL from primary at 0/3000000 on timeline 1
```

## Step 3: Initialize the database

> Host: qday-sg-04(119.13.103.230)

Into postgres container.

```bash
$ docker exec -it postgres psql -U postgres
```

Create L1 Explorer database and user.

```sql
CREATE USER l1_explorer_user WITH LOGIN ENCRYPTED PASSWORD '1eZ17iRs107FSheO';
CREATE DATABASE l1_explorer_db WITH OWNER = l1_explorer_user;
\c l1_explorer_db;
GRANT ALL ON SCHEMA public TO l1_explorer_user;
```

Create QDAY Explorer database and user.

```sql
CREATE ROLE qday_explorer_user WITH LOGIN ENCRYPTED PASSWORD 'Be5nfBEymMmQRS1D';
CREATE DATABASE qday_explorer_db WITH OWNER = qday_explorer_user;
\c qday_explorer_db;
GRANT ALL ON SCHEMA public TO qday_explorer_user;
```

Create State database and user.

```sql
CREATE USER state_user WITH LOGIN ENCRYPTED PASSWORD 'LEzCfmbigYi1tgpG';
CREATE DATABASE state_db WITH OWNER = state_user;
\c state_db;
GRANT ALL ON SCHEMA public TO state_user;
```

Create Pool database and user.

```sql
CREATE USER pool_user WITH LOGIN ENCRYPTED PASSWORD '2Ra0IEJ1Q54PVre0';
CREATE DATABASE pool_db WITH OWNER = pool_user;
\c pool_db;
GRANT ALL ON SCHEMA public TO pool_user;
```

Create Prover database and user.

```sql
CREATE USER prover_user WITH LOGIN ENCRYPTED PASSWORD 'hpt4CjGqocp01xRI';
CREATE DATABASE prover_db WITH OWNER = prover_user;
\c prover_db;
CREATE SCHEMA state;
CREATE TABLE state.nodes (hash BYTEA PRIMARY KEY, data BYTEA NOT NULL);
CREATE TABLE state.program (hash BYTEA PRIMARY KEY, data BYTEA NOT NULL);
ALTER DATABASE prover_db OWNER TO prover_user;
ALTER SCHEMA state OWNER TO prover_user;
ALTER SCHEMA public OWNER TO prover_user;
ALTER TABLE state.nodes OWNER TO prover_user;
ALTER TABLE state.program OWNER TO prover_user;
ALTER USER prover_user SET SEARCH_PATH=state;
```

Create Event database and user.

```sql
CREATE USER event_user WITH LOGIN ENCRYPTED PASSWORD 'aZcK7kzJ8aU58uHE';
CREATE DATABASE event_db WITH OWNER = event_user;
\c event_db;
GRANT ALL ON SCHEMA public TO event_user;
```

Use event_user to create the table.

```bash
$ docker exec -it postgres psql 'postgres://event_user:aZcK7kzJ8aU58uHE@119.13.103.230:5432/event_db'
```

```sql
CREATE TYPE level_t AS ENUM ('emerg', 'alert', 'crit', 'err', 'warning', 'notice', 'info', 'debug');
CREATE TABLE public.event (
   id BIGSERIAL PRIMARY KEY,
   received_at timestamp WITH TIME ZONE default CURRENT_TIMESTAMP,
   ip_address inet,
   source varchar(32) not null,
   component varchar(32),
   level level_t not null,
   event_id varchar(32) not null,
   description text,
   data bytea,
   json jsonb
);
```

## Step 4: Test

> Host: abec-fn00-hz01(116.202.169.210)

Try to login from slave.

```bash
$ docker exec -it postgres psql 'postgres://event_user:aZcK7kzJ8aU58uHE@116.202.169.210:5432/event_db'
```

```sql
event_db=> SELECT * FROM public.event;
 id | received_at | ip_address | source | component | level | event_id | description | data | json
----+-------------+------------+--------+-----------+-------+----------+-------------+------+------
(0 rows)
```